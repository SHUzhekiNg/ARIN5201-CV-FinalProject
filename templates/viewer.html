<!-- templates/viewer.html -->
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>3D File Viewer{{ job.id }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- model-viewer：支持 glTF/GLB、PBR、相机控制等 -->
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

    <style>
      html, body { height: 100%; margin: 0; background: #121212; color: #eee; }
        header {
            padding: 10px 16px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        header a { color: #8ab4f8; text-decoration: none; }
        .viewer-wrap { height: calc(100% - 56px); display: grid; grid-template-columns: 1fr 320px; gap:0; }
        .viewer-left { padding: 12px; display:flex; align-items:center; justify-content:center; height:100%; }
        .panel { padding: 12px 16px; border-left: 1px solid #2a2a2a; overflow: auto; }
        .square { width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
        .frame { width:100%; max-width:100%; max-height:100%; aspect-ratio:1 / 1; }
        model-viewer { width: 100%; height:100%; background: #1a1a1a; border-radius:8px; display:block; }
        /* Force the internal progress bar to a fixed green color */
        model-viewer { --progress-bar-color: #4caf50; }
        model-viewer::part(progress-bar) { background: rgba(0,0,0,0); }
        model-viewer::part(progress-bar-value), model-viewer::part(progress) { background: #4caf50 !important; }
        .btn { padding: 8px 12px; background: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 6px; color: #eee; cursor: pointer; }
        .btn + .btn { margin-left: 8px; }
        .kv { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
        .kv div { margin: 6px 0; }
        .kv span { display: inline-block; min-width: 96px; color: #bbb; }
        .hint { color:#aaa; margin:10px 0 10px 0; line-height:1.25; }
        .controls .btn { margin-right:8px; }
        .userInput {height: 100%;}
        /* upload box styles (match index.html style) */
        .upload-center { display:flex; justify-content:center; }
        .file-drop { box-sizing: border-box; width: 560px; height: 260px; border: 2px dashed #444; border-radius: 10px; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.01); cursor:pointer; }
        .file-drop:focus { outline: 3px solid rgba(74,144,226,0.18); }
        .file-drop-placeholder { text-align:center; color:#bbb; }
        .file-drop-placeholder div.plus { font-size:72px; line-height:1; color:#888; }
        .file-drop .file-info { margin-top:12px; color:#999; font-size:13px; }
    </style>
</head>

<body>
  <header>
    <strong>3D File Viewer</strong>
    <span style="flex:1"></span>
    <a href="/" style="color:#8ab4f8; text-decoration:none;">← Back to Inference</a>
  </header>


<div class="viewer-wrap">
  {% if waiting %}
  <div style="padding:28px; width:100%">
    <h2 style="color:#ddd">Upload GLB File and Visualize</h2>
    <form id="uploadForm" action="/view/upload" method="post" enctype="multipart/form-data">
      <div style="margin:12px 0" class="upload-center">
        <div class="file-drop" id="fileDrop" tabindex="0" aria-label="Drag or drop GLB file here">
          <input id="glbInput" type="file" name="glb" accept=".glb" style="display:none" />
          <div class="file-drop-placeholder" id="fileDropPlaceholder">
            <div class="plus">+</div>
            <div style="margin-top:8px; color:#bbb">Drag or click to upload GLB</div>
            <div id="fileName" class="file-info"></div>
          </div>
        </div>
      </div>
      <div style="text-align:center; margin-top:12px">
        <button class="btn" type="submit">Upload</button>
      </div>
    </form>
    <p style="color:#999; margin-top:12px">Or you can view an output of previous work by URL  <code>/view/&lt;job_id&gt;</code>.</p>
  </div>
  {% else %}
  <div class="viewer-left">
    <div class="square">
      <div class="frame">
        <model-viewer id="mv"
          src="{{ glb_url }}"
          camera-controls
          interaction-prompt="auto"
          exposure="0.9"
          tone-mapping="ACES"
          shadow-intensity="0.6"
          environment-image="https://modelviewer.dev/shared-assets/environments/neutral.hdr"></model-viewer>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="kv">
      <div><span>Work ID</span>{% if job %}{{ job.id }}{% else %}-{% endif %}</div>
      <div><span>Model</span>{% if job %}{{ job.model }}{% else %}-{% endif %}</div>
      <div><span>GPU</span>{% if job %}{{ job.gpu }}{% else %}-{% endif %}</div>
      <div><span>Type of File</span>{{ kind or '-' }}</div>
      <div><span>Download</span>{% if glb_url %}<a href="{{ glb_url }}">Download GLB</a>{% else %}-{% endif %}</div>
    </div>

    <h3>How to Operate</h3>
    <p class="hint"><span>Tips: hold left mouse to rotate, middle to pan, wheel to zoom.</span></p>

    <div class="controls" style="margin-bottom:12px">
      <button class="btn" id="btnWire">WireBox</button>
      <button class="btn" id="btnReset">Reset the Camera</button>
      <button class="btn" id="btnScreenshot">ScreenShot</button>
    </div>
  </div>
  {% endif %}
</div>


  <script type="module">
    const mv = document.getElementById('mv');
    if (mv) {
      // 线框开关（通过 scene-graph 操作）
      let wireframeOn = false;
      const btnWire = document.getElementById('btnWire');
      if (btnWire) btnWire.addEventListener('click', async () => {
        await mv.updateComplete; // 确保加载完成
        const scene = mv.scene;
        if (!scene) return;
        wireframeOn = !wireframeOn;
        for (const mesh of scene.model?.meshes || []) {
          const mat = mesh.material;
          if (mat) mat.wireframe = wireframeOn;
        }
      });

      // 重置相机
      const btnReset = document.getElementById('btnReset');
      if (btnReset) btnReset.addEventListener('click', () => {
        mv.resetTurntableRotation();
        mv.cameraOrbit = "auto auto auto";
        mv.fieldOfView = "auto";
      });

      // 简单截图：使用 <model-viewer> 的 toBlob
      const btnScreenshot = document.getElementById('btnScreenshot');
      if (btnScreenshot) btnScreenshot.addEventListener('click', async () => {
        const blob = await mv.toBlob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `{{ job.id if job else 'capture' }}.png`;
        a.click();
        URL.revokeObjectURL(url);
      });
    }
  </script>
  <script>
    // Drag/drop upload script with fallback upload via fetch when assigning input.files is not allowed
    (function(){
      const drop = document.getElementById('fileDrop');
      const input = document.getElementById('glbInput');
      const nameEl = document.getElementById('fileName');
      const form = document.getElementById('uploadForm');
      let droppedFile = null;

      if (!drop || !input || !form) return;

      function showFile(file){
        if (!file) { nameEl.textContent = ''; return; }
        nameEl.textContent = file.name + ' (' + Math.round(file.size/1024) + ' KB)';
      }

      drop.addEventListener('click', () => input.click());
      drop.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); input.click(); } });

      drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.style.borderColor = '#4a90e2'; drop.style.background = 'rgba(74,144,226,0.02)'; });
      drop.addEventListener('dragleave', (e) => { e.preventDefault(); drop.style.borderColor = ''; drop.style.background = 'rgba(255,255,255,0.01)'; });
      drop.addEventListener('drop', (e) => {
        e.preventDefault(); drop.style.borderColor = ''; drop.style.background = 'rgba(255,255,255,0.01)';
        const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if (f) {
          droppedFile = f;
          // Try to set input.files (may be read-only in some browsers)
          try {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(f);
            input.files = dataTransfer.files;
          } catch (err) {
            // fallback: keep droppedFile and handle on submit
            console.warn('Could not assign to input.files, will upload via fetch on submit', err);
          }
          showFile(f);
        }
      });

      input.addEventListener('change', (e) => {
        const f = input.files && input.files[0];
        if (f) droppedFile = f;
        showFile(f);
      });

      // Intercept form submit: if input.files empty but we have droppedFile, upload via fetch
      form.addEventListener('submit', async (e) => {
        if ((!input.files || input.files.length === 0) && droppedFile) {
          e.preventDefault();
          const fd = new FormData();
          fd.append('glb', droppedFile, droppedFile.name);
          try {
            const resp = await fetch(form.action, { method: 'POST', body: fd, credentials: 'same-origin' });
            if (resp.redirected) {
              window.location.href = resp.url;
              return;
            }
            // If server returns HTML or JSON with redirect URL, try to handle
            const text = await resp.text();
            // naïve attempt: if response contains a link to /view, navigate there
            const m = text.match(/href="(\/view[^"]+)"/i);
            if (m) { window.location.href = m[1]; return; }
            // fallback: reload
            window.location.reload();
          } catch (err) {
            console.error('Upload failed', err);
            alert('Upload failed: ' + err.message);
          }
        }
      });
    })();
  </script>
</body>
</html>
